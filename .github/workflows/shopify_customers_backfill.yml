{\rtf1\ansi\ansicpg1252\cocoartf2867
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 name: Shopify Customers Backfill (History)\
\
on:\
  schedule:\
    - cron: "*/10 * * * *"   # roda a cada 10 min at\'e9 terminar\
  workflow_dispatch:\
\
permissions:\
  contents: read\
\
jobs:\
  run-backfill:\
    runs-on: ubuntu-latest\
    timeout-minutes: 20\
\
    steps:\
      - name: Checkout repo\
        uses: actions/checkout@v4\
\
      - name: Setup Python\
        uses: actions/setup-python@v5\
        with:\
          python-version: "3.12"\
\
      - name: Install deps\
        run: |\
          python -m pip install --upgrade pip\
          pip install -r requirements.txt\
\
      - name: Run Customers Backfill\
        env:\
          SHOPIFY_SHOP: $\{\{ secrets.SHOPIFY_SHOP \}\}\
          SHOPIFY_ADMIN_TOKEN: $\{\{ secrets.SHOPIFY_ADMIN_TOKEN \}\}\
          POSTGRES_URL: $\{\{ secrets.POSTGRES_URL \}\}\
          SHOPIFY_API_VERSION: "2025-01"\
          MAX_RUNTIME_MIN: "18"\
        run: |\
          set -euo pipefail\
          start_ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")\
\
          python shopify_customers_to_postgres_backfill.py 2>&1 | tee etl.log\
\
          end_ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")\
          last_ok=$(grep -E "OK: upsert|PARTIAL:" etl.log | tail -n 1 || true)\
\
          \{\
            echo "## Shopify Customers Backfill - Resumo"\
            echo ""\
            echo "- In\'edcio (UTC): \\`$start_ts\\`"\
            echo "- Fim (UTC): \\`$end_ts\\`"\
            echo ""\
            echo "### \'daltimo status"\
            if [ -n "$last_ok" ]; then\
              echo "\\`$last_ok\\`"\
            else\
              echo "_N\'e3o encontrei linha OK/PARTIAL no log (ver logs completos)._"\
            fi\
          \} >> "$GITHUB_STEP_SUMMARY"}