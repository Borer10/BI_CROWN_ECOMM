name: Shopify ETL Incremental

on:
  # schedule:
  #   # Executa a cada 3 horas (UTC)
  #   # Exemplo de execuções: 00:00, 03:00, 06:00, 09:00...
  #   - cron: "0 */3 * * *"

  # Permite execução manual pelo GitHub Actions
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-etl:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Orders + Customers ETL
        env:
          SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
          SHOPIFY_ADMIN_TOKEN: ${{ secrets.SHOPIFY_ADMIN_TOKEN }}
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          SHOPIFY_API_VERSION: "2025-01"
          # tempo total do job é 20 min; vamos dividir via MAX_RUNTIME por script
          ORDERS_MAX_RUNTIME_MIN: "11"
          CUSTOMERS_MAX_RUNTIME_MIN: "8"
          # safety window (padrão bom)
          SAFETY_WINDOW_MIN: "120"
        run: |
          set -euo pipefail
          start_ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          echo "== Rodando ORDERS incremental =="
          MAX_RUNTIME_MIN="${ORDERS_MAX_RUNTIME_MIN}" \
            python shopify_to_postgres_incremental.py 2>&1 | tee orders.log

          echo "== Rodando CUSTOMERS incremental =="
          MAX_RUNTIME_MIN="${CUSTOMERS_MAX_RUNTIME_MIN}" \
            SAFETY_WINDOW_MIN="${SAFETY_WINDOW_MIN}" \
            python shopify_customers_to_postgres_incremental.py 2>&1 | tee customers.log

          end_ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          last_ok_orders=$(grep -E "OK: upsert|PARTIAL:" orders.log | tail -n 1 || true)
          last_ok_customers=$(grep -E "OK: upsert|PARTIAL:" customers.log | tail -n 1 || true)

          {
            echo "## Shopify ETL - Resumo"
            echo ""
            echo "- Início (UTC): \`$start_ts\`"
            echo "- Fim (UTC): \`$end_ts\`"
            echo ""
            echo "### ORDERS (incremental)"
            if [ -n "$last_ok_orders" ]; then
              echo "\`$last_ok_orders\`"
            else
              echo "_Não encontrei linha OK/PARTIAL no log de orders (ver orders.log)._"
            fi
            echo ""
            echo "### CUSTOMERS (incremental)"
            if [ -n "$last_ok_customers" ]; then
              echo "\`$last_ok_customers\`"
            else
              echo "_Não encontrei linha OK/PARTIAL no log de customers (ver customers.log)._"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: etl-logs
          path: |
            orders.log
            customers.log
          if-no-files-found: ignore

      - name: Send email on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.ALERT_EMAIL_FROM }}
          password: ${{ secrets.ALERT_EMAIL_PASSWORD }}
          subject: "❌ Erro no ETL Shopify - BI Crown"
          to: ${{ secrets.ALERT_EMAIL_TO }}
          from: ${{ secrets.ALERT_EMAIL_FROM }}
          body: |
            O job de ETL Shopify falhou.

            Repositório: ${{ github.repository }}
            Workflow: ${{ github.workflow }}
            Job: ${{ github.job }}
            Data: ${{ github.run_started_at }}

            Logs:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}